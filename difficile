SELECT CUSTOMERS.CUSTOMER_CODE
FROM CUSTOMERS
INNER JOIN ORDERS ON CUSTOMERS.CUSTOMER_CODE = ORDERS.CUSTOMER_CODE
WHERE CITY = 'Berlin'
  AND CUSTOMERS.CUSTOMER_CODE IN (
    SELECT ORDERS.CUSTOMER_CODE
    FROM ORDERS
    WHERE ORDER_NUMBER IN (
      SELECT ORDER_NUMBER
      FROM ORDER_DETAILS
      GROUP BY ORDER_NUMBER, QUANTITY
      HAVING COUNT(*) <= 1));


  /* Question 9: Afficher les clients résident en France
  -----------------------------------------------------*/
  SELECT CUSTOMERS.CUSTOMER_CODE, PHONE, COUNTRY, COMPANY, SUM(ORDER_DETAILS.QUANTITY) AS TQ_France
  FROM CUSTOMERS
  INNER JOIN ORDERS ON CUSTOMERS.CUSTOMER_CODE = ORDERS.CUSTOMER_CODE
  INNER JOIN ORDER_DETAILS ON ORDERS.ORDER_NUMBER = ORDER_DETAILS.ORDER_NUMBER
  WHERE CUSTOMERS.COUNTRY = 'France' 
	AND DATEPART(WEEKDAY, ORDER_DATE) = 2  
    AND ORDER_DATE BETWEEN '1996-04-01' AND '1996-04-30'
GROUP BY CUSTOMERS.CUSTOMER_CODE, PHONE, COMPANY, COUNTRY;
	
/* QUESTION 10 : Les clients qui ont acheté tout les produits */

SELECT CUSTOMERS.CUSTOMER_CODE, CUSTOMERS.COMPANY, CUSTOMERS.PHONE
  FROM CUSTOMERS
  INNER JOIN ORDERS ON CUSTOMERS.CUSTOMER_CODE = ORDERS.CUSTOMER_CODE
  INNER JOIN ORDER_DETAILS ON ORDERS.ORDER_NUMBER = ORDER_DETAILS.ORDER_NUMBER
 WHERE CUSTOMERS.CUSTOMER_CODE IN (
  SELECT ORDERS.CUSTOMER_CODE
    FROM ORDERS
    WHERE ORDER_NUMBER IN (
      SELECT ORDER_NUMBER
      FROM ORDER_DETAILS
      GROUP BY ORDER_NUMBER, QUANTITY
      HAVING COUNT(*) = 11));

/*Question 11 Afficher le nombre de commande pour chaque client de France*/

SELECT CUSTOMERS.CUSTOMER_CODE, SUM(ORDER_DETAILS.QUANTITY) AS TotalQuantity
FROM CUSTOMERS
INNER JOIN ORDERS ON CUSTOMERS.CUSTOMER_CODE = ORDERS.CUSTOMER_CODE
INNER JOIN ORDER_DETAILS ON ORDERS.ORDER_NUMBER = ORDER_DETAILS.ORDER_NUMBER
WHERE CUSTOMERS.COUNTRY = 'France'
GROUP BY CUSTOMERS.CUSTOMER_CODE;

/* Question 12 Le nombre commande passer en 1996, 1997 et diiferrence */

SELECT SUM(CASE WHEN DATEPART(YEAR, ORDER_DATE) = 1996 THEN ORDER_DETAILS.QUANTITY ELSE 0 END) AS TQ_1996,
  SUM(CASE WHEN DATEPART(YEAR, ORDER_DATE) = 1997 THEN ORDER_DETAILS.QUANTITY ELSE 0 END) AS TQ_1997,
  SUM(CASE WHEN DATEPART(YEAR, ORDER_DATE) = 1997 THEN ORDER_DETAILS.QUANTITY ELSE 0 END) - 
  SUM(CASE WHEN DATEPART(YEAR, ORDER_DATE) = 1996 THEN ORDER_DETAILS.QUANTITY ELSE 0 END) AS Diff_TQ_1997_1996 
FROM CUSTOMERS
INNER JOIN ORDERS ON CUSTOMERS.CUSTOMER_CODE = ORDERS.CUSTOMER_CODE
INNER JOIN ORDER_DETAILS ON ORDERS.ORDER_NUMBER = ORDER_DETAILS.ORDER_NUMBER
WHERE DATEPART(YEAR, ORDER_DATE) IN (1996, 1997)
GROUP BY CUSTOMERS.CUSTOMER_CODE
